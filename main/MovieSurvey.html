{{ block title }}
Movie {{ movie_number }} of {{ total_movies }}
{{ endblock }}

{{ block styles }}
<link href="https://unpkg.com/survey-core@2.5.9/survey-core.min.css" rel="stylesheet">
<style>
    .movie-card {
        max-width: none;
        height: 100%;
        border: 1px solid #d6d9dd;
    }

    .movie-poster {
        max-width: 320px;
        width: 100%;
        border: 2px solid #cfd4da;
        border-radius: 10px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.18);
    }

    .synopsis-box {
        max-width: 640px;
        background: #f8f9fa;
        border: 1px solid #d6d9dd;
        border-radius: 10px;
        box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.6);
    }

    .survey-card {
        max-width: none;
        border: 1px solid #d6d9dd;
    }

    #surveyContainer .sd-btn.sd-navigation__next-btn,
    #surveyContainer .sd-btn.sd-navigation__complete-btn,
    #surveyContainer .sv-root-modern .sv-footer__next-btn,
    #surveyContainer .sv-root-modern .sv-footer__complete-btn {
        box-sizing: border-box;
        margin: 0;
        font-family: inherit;
        text-transform: none;
        -webkit-appearance: button;
        display: inline-block;
        font-weight: 400;
        line-height: 1.5;
        text-align: center;
        text-decoration: none;
        vertical-align: middle;
        user-select: none;
        border: 1px solid transparent;
        padding: 0.375rem 0.75rem;
        font-size: 1rem;
        border-radius: 0.25rem;
        transition: color 0.15s ease-in-out, background-color 0.15s ease-in-out,
            border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        color: #fff;
        background-color: #0d6efd;
        border-color: #0d6efd;
        cursor: pointer;
    }

    #surveyContainer .sd-btn.sd-navigation__next-btn:hover,
    #surveyContainer .sd-btn.sd-navigation__complete-btn:hover,
    #surveyContainer .sv-root-modern .sv-footer__next-btn:hover,
    #surveyContainer .sv-root-modern .sv-footer__complete-btn:hover {
        color: #fff;
        background-color: #0b5ed7;
        border-color: #0a58ca;
    }

    #surveyContainer .sd-btn.sd-navigation__next-btn:focus,
    #surveyContainer .sd-btn.sd-navigation__complete-btn:focus,
    #surveyContainer .sv-root-modern .sv-footer__next-btn:focus,
    #surveyContainer .sv-root-modern .sv-footer__complete-btn:focus {
        color: #fff;
        background-color: #0b5ed7;
        border-color: #0a58ca;
        outline: 0;
        box-shadow: 0 0 0 0.25rem rgba(49, 132, 253, 0.5);
    }

    #surveyContainer .sd-btn.sd-navigation__next-btn:active,
    #surveyContainer .sd-btn.sd-navigation__complete-btn:active,
    #surveyContainer .sv-root-modern .sv-footer__next-btn:active,
    #surveyContainer .sv-root-modern .sv-footer__complete-btn:active {
        color: #fff;
        background-color: #0a58ca;
        border-color: #0a53be;
    }

    #surveyContainer .sd-btn.sd-navigation__next-btn:disabled,
    #surveyContainer .sd-btn.sd-navigation__complete-btn:disabled,
    #surveyContainer .sv-root-modern .sv-footer__next-btn:disabled,
    #surveyContainer .sv-root-modern .sv-footer__complete-btn:disabled {
        color: #fff;
        background-color: #0d6efd;
        border-color: #0d6efd;
        opacity: 0.65;
        cursor: default;
        pointer-events: none;
    }

    #surveyContainer .sv-root-modern,
    #surveyContainer .sd-root-modern {
        --sjs-general-backcolor: transparent;
        --sjs-general-backcolor-dim-light: transparent;
        --sjs-general-backcolor-dim-dark: transparent;
        background-color: transparent;
    }
</style>
{{ endblock }}

{{ block content }}
<div class="d-flex justify-content-between align-items-center mb-3">
    <span class="badge text-bg-primary">Movie {{ movie_number }} of {{ total_movies }}</span>
    <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#instructionsModal">
        Instructions
    </button>
</div>

<div class="row g-4 align-items-start">
    <div class="col-12 col-lg-6">
        <div class="card movie-card shadow-sm">
            <div class="card-body text-center p-4">
                <h3 class="mb-1">{{ movie.title }}</h3>
                <img src="{{ movie_image_url }}" alt="{{ movie.title }} poster" class="movie-poster img-fluid">

                <div class="synopsis-box mx-auto mt-4 p-3 text-start">
                    <div class="text-uppercase fw-semibold text-primary small mb-2">Movie Description</div>
                    <p class="mb-0">{{ movie.synopsis }}</p>
                </div>
            </div>
        </div>
    </div>
    <div class="col-12 col-lg-6">
        <div class="card survey-card shadow-sm">
            <div class="card-body p-4">
                <div id="surveyContainer"></div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="instructionsModal" tabindex="-1" aria-labelledby="instructionsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="instructionsModalLabel">Study Instructions</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                {{ include 'intro/includes/study_instructions_body.html' }}
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<input type="hidden" id="surveyResults" name="surveyResults" value="">
{{ endblock }}

{{ block scripts }}
<script src="https://unpkg.com/survey-core@2.5.9/survey.core.min.js"></script>
<script src="https://unpkg.com/survey-js-ui@2.5.9/survey-js-ui.min.js"></script>
<script>
    function scrollToTopOnMobile() {
        if (!window.matchMedia("(max-width: 991.98px)").matches) {
            return;
        }
        window.scrollTo({top: 0, behavior: "smooth"});
        document.documentElement.scrollTop = 0;
        document.body.scrollTop = 0;
    }

    async function initMovieSurvey() {
        try {
            const response = await fetch("/static/movie_survey.json", {cache: "no-store"});
            if (!response.ok) {
                throw new Error(`HTTP ${response.status} while loading movie_survey.json`);
            }
            const surveyJson = await response.json();
            const survey = new Survey.Model(surveyJson);
            survey.showPrevButton = false;
            survey.showCompletedPage = false;

            survey.onTextMarkdown.add(function (_, options) {
                options.html = (options.text || "")
                    .replace(/<gray>(.*?)<\/gray>/g, "<span style=\"color:#6c757d;\">$1</span>")
                    .replace(/<red>(.*?)<\/red>/g, "<span style=\"color:#dc3545;\">$1</span>")
                    .replace(/\*(.*?)\*/g, "<em>$1</em>");
            });

            survey.onCurrentPageChanged.add(function () {
                window.setTimeout(scrollToTopOnMobile, 0);
            });

            survey.onComplete.add(function (sender) {
                document.getElementById("surveyResults").value = JSON.stringify(sender.data);
                document.getElementById("form").submit();
            });

            survey.render(document.getElementById("surveyContainer"));
        } catch (error) {
            console.error("Failed to initialize MovieSurvey JSON:", error);
            document.getElementById("surveyContainer").innerHTML =
                '<div class="alert alert-danger mb-0">Could not load the survey. Please reload the page.</div>';
        }
    }

    initMovieSurvey();
</script>
{{ endblock }}
